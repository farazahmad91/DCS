@model IEnumerable<Entities.Medicines>
@{
    ViewData["Title"] = "AddInvoice";
    Layout = null;
}
<style>
    .border-right {
        border-right: 1px solid #ccc;
        padding-right: 15px; 
    }

</style>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
<div class="modal fade" id="AddInvoice_Modal" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Add New Invoice</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <div class="card">
                            <div class="row gx-3">
                                <div class="col-sm-6 col-6 card border-right">
                                    <div class="row gx-3">
                                        <div class="col-sm-6 col-12">
                                            <div class="mb-3">
                                                <label for="customerName" class="form-label">Customer Name</label>
                                                <input type="text" id="txtName" class="form-control" placeholder="Enter Customer Name" />
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-12">
                                            <div class="mb-3">
                                                <label for="txtEmail" class="form-label">Email</label>
                                                <div class="input-group">
                                                    <input type="email" id="txtEmail" class="form-control" placeholder="Enter Email" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-12">
                                            <div class="mb-3">
                                                <label for="txtPhone" class="form-label">Mobile No.</label>
                                                <input type="text" id="txtPhone" class="form-control" placeholder="Enter Mobile Number" />
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-12">
                                            <div class="mb-3">
                                                <label for="txtAddress" class="form-label">Address</label>
                                                <div class="input-group">
                                                    <input type="text" id="txtAddress" class="form-control" placeholder="Enter Address" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 col-4 card">
                                    <!-- Transaction details section -->
                                    <div class="row gx-3">
                                        <div class="col-sm-6 col-12">
                                            <div class="mb-3">
                                                <label for="customerName" class="form-label">Transaction Mode</label>
                                                <select class="form-select" id="txtTMode" onchange="OnTransaction();">
                                                    <option value="">Select Mode</option>
                                                    <option value="Online">Online</option>
                                                    <option value="Cash">Cash</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-12">
                                            <div class="mb-3">
                                                <label class="form-label">Transaction Id</label>
                                                <div class="input-group">
                                                    <input type="text" id="txtTransactionId" class="form-control" placeholder="Enter Transaction Id" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-12">
                                            <div class="mb-3">
                                                <label class="form-label">Due Date</label>
                                                <div class="input-group">
                                                    <input type="text" id="txtduedate" class="form-control datepicker-time" disabled="disabled">
                                                    <span class="input-group-text">
                                                        <i class="bi bi-calendar4"></i>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-12">
                                            <label class="form-label">IsPaid</label>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" role="switch" onchange="OnTransaction();" id="ckbIsPaid" checked="">
                                                <label class="form-check-label" for="ckbIsPaid"></label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <hr />
                        <div class="row gx-3">
                            <div class="col-12">
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th style="width:15%;">Service</th>
                                                <th>Product</th>
                                                @* <th>Unit</th> *@
                                                <th style="width:12%;">Quantity</th>
                                                <th style="width:12%;">Price (₹) </th>
                                                <th style="width:12%;">VAT (%) </th>
                                                <th style="width:12%;">Discount (%) </th>
                                                <th style="width:12%;">Amount (₹ Net)</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbody">
                                            <tr class="rowClass">
                                                <td>
                                                    <input type="text" class="form-control" id="txtService0" placeholder="please enter service" />
                                                </td>
                                                <td>
                                                    <div class="m-0">
                                                        <select class="form-select product-select" id="txtProduct0" style="width:150px;">
                                                            <option value="">Select medicine</option>
                                                            @foreach (var item in Model)
                                                            {

                                                                <option value="@item.MedicineID">@item.Name</option>
                                                            }
                                                        </select>
                                                    </div>
                                                </td>
                                                @*   <td>
                                                <select class="form-select" id="txtUnit0">
                                                <option>Select Unit</option>
                                                <option>tablet</option>
                                                <option>Books</option>
                                                </select>
                                                </td> *@
                                                <td>
                                                    <div class="m-0">
                                                        <input type="number" class="form-control" id="txtQty0" onchange="txtonChange();" placeholder="Qty" />
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="input-group m-0">
                                                        <input type="text" id="txtPrice0" onchange="txtonChange();" class="form-control" placeholder="Price" />
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="input-group m-0">
                                                        <input type="text" id="txtVat0" onchange="txtonChange();" class="form-control" placeholder="Vat" />
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="input-group m-0">
                                                        <input type="text" id="txtDiscount0" onchange="txtonChange();" class="form-control" placeholder="Discount" />

                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="input-group m-0">
                                                        <input type="text" id="txtTotalAmount0" class="form-control" placeholder="Total Amount" readonly />

                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="d-inline-flex gap-1">
                                                        <button class="btn btn-danger remove">
                                                            <i class="mdi mdi-delete"></i>
                                                        </button>
                                                        <button class="btn btn-dark" id="btnaddnew">
                                                            <i class=" uil-plus"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan="6">&nbsp;</td>
                                                <td>
                                                    <p class="m-0">Subtotal</p>
                                                    <p class="m-0">Discount</p>
                                                    <p class="m-0">VAT</p>
                                                    <h5 class="mt-2 text-red">Total INR</h5>
                                                </td>
                                                <td>
                                                    <p class="m-0" id="subtotal">₹0.00</p>
                                                    <p class="m-0" id="discountAmount">₹0.00</p>
                                                    <p class="m-0" id="vatAmount">₹0.00</p>
                                                    <h5 class="mt-2 text-red" id="totalAmount">₹0.00</h5>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="text-end">
                                    <button class="btn btn-outline-success" onclick="CreateInvoice();">
                                        Create Invoice
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
    function OnTransaction() {
        var mode = $("#txtTMode").val();

        if (mode === 'Cash') {
            $("#txtTransactionId").val('not');
            $("#txtTransactionId").prop("disabled", true);
        } else {
            $("#txtTransactionId").prop("disabled", false);
        }
        debugger;
        var isPaid = $("#ckbIsPaid").prop('checked');
        if (!isPaid) {
            $("#txtduedate").val("");
        }
        else {
            $("#txtduedate").val("");
        }
    }
    OnTransaction();

    let count = 1;
    $(document).ready(() => {
        $('#tbody').on('click', '#btnaddnew', function (e) {
            e.preventDefault();
            let currentRow = $(this).closest('.rowClass');
            let isValid = validateRow(currentRow);

            if (isValid) {
                GetMedicines().then(options => {
                    let dynamicRowHTML = `
                            <tr class="rowClass">
                                <td>
                                         <input type="text" class="form-control" id="txtService${count}"  placeholder="please enter service" />
                                </td>
                                <td>
                                    <div class="m-0">
                                        <select class="form-control product-select" id="txtProduct${count}">
                                            ${options}
                                        </select>
                                    </div>
                                </td>
                                <td>
                                    <div class="m-0">
                                        <input type="number" class="form-control" id="txtQty${count}" onchange="txtonChange();" placeholder="Qty" />
                                    </div>
                                </td>
                                <td>
                                    <div class="input-group m-0">
                                        <input type="text" id="txtPrice${count}" onchange="txtonChange();" class="form-control" placeholder="Price"/>
                                        <span class="input-group-text">₹</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="input-group m-0">
                                        <input type="text" id="txtVat${count}" onchange="txtonChange();" class="form-control" placeholder="Vat"/>
                                        <span class="input-group-text">%</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="input-group m-0">
                                        <input type="text" id="txtDiscount${count}" onchange="txtonChange();" class="form-control" placeholder="Discount"/>
                                        <span class="input-group-text">%</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="input-group m-0">
                                        <input type="text" id="txtTotalAmount${count}" class="form-control" placeholder="Total Amount" readonly/>
                                        <span class="input-group-text">₹</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-inline-flex gap-1">
                                            <button class="btn btn-danger remove">
                                                <i class="mdi mdi-delete"></i>
                                        </button>
                                        <button class="btn btn-dark" id="btnaddnew">
                                                <i class=" uil-plus"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>`;

                    $('#tbody tr:last').before(dynamicRowHTML);
                    $(`#txtProduct${count}`).select2({
                        placeholder: "Select a product",
                        allowClear: true
                    });
                    count++;
                }).fail(() => {
                    alert('Failed to fetch medicines.');
                });
            } else {
                Info(-1, 'Please fill all the fields before adding a new row.');
            }
        });

        $('#tbody').on('click', '.remove', function () {
            $(this).closest('.rowClass').remove();
            txtonChange();
        });

        $('body').on('change', '.form-control', function () {
            txtonChange();
        });

        $('body').on('change', '.form-select', function () {
            txtonChange();
        });
        jQuery.noConflict();

        $("#txtProduct0").select2({
            placeholder: "Select a product",
            allowClear: true
        });

        GetMedicines();
    });

    function validateRow(row) {
        let isValid = true;
        row.find('select, input').each(function () {
            if ($(this).val() === '' || $(this).val() == null) {
                isValid = false;
            }
        });
        return isValid;
    }

    function txtonChange() {
        let subtotal = 0;
        let totalDiscount = 0;
        let totalVAT = 0;

        $('.rowClass').each(function (index, element) {
            let qty = parseFloat($(element).find('input[id^="txtQty"]').val()) || 0;
            let price = parseFloat($(element).find('input[id^="txtPrice"]').val()) || 0;
            let vat = parseFloat($(element).find('input[id^="txtVat"]').val()) || 0;
            let discount = parseFloat($(element).find('input[id^="txtDiscount"]').val()) || 0;

            let total = qty * price;
            let vatAmount = (total * vat) / 100;
            let discountAmount = (total * discount) / 100;

            let netAmount = total + vatAmount - discountAmount;

            subtotal += total;
            totalVAT += vatAmount;
            totalDiscount += discountAmount;

            $(element).find('input[id^="txtTotalAmount"]').val(netAmount.toFixed(2));
        });

        $('#subtotal').text(`₹${subtotal.toFixed(2)}`);
        $('#vatAmount').text(`₹${totalVAT.toFixed(2)}`);
        $('#discountAmount').text(`₹${totalDiscount.toFixed(2)}`);
        $('#totalAmount').text(`₹${(subtotal + totalVAT - totalDiscount).toFixed(2)}`);
    }

    function CreateInvoice() {
        if (!validateInvoiceFields()) {
            Info(-1, 'Please fill all the required fields.');
            return;
        }

        let invoiceData = {
            CustomerName: $('#txtName').val(),
            Email: $('#txtEmail').val(),
            Phone: $('#txtPhone').val(),
            Address: $('#txtAddress').val(),
            Subtotal: parseFloat($('#subtotal').text().replace('₹', '')) || 0,
            DiscountAmount: parseFloat($('#discountAmount').text().replace('₹', '')) || 0,
            TotalVAT: parseFloat($('#vatAmount').text().replace('₹', '')) || 0,
            TotalAmount: parseFloat($('#totalAmount').text().replace('₹', '')) || 0,
            Items: [],
            Transactions: []
        };

        let transaction = {
            Id: $('#txtTransactionId').val(),
            Mode: $('#txtTMode').val(),
            IsPaid: $("#ckbIsPaid").prop('checked'),
            DueDate: $('#txtduedate').val(),
        };
        invoiceData.Transactions.push(transaction);

        $('.rowClass').each(function (index, element) {
            let service = $(element).find('input[id^="txtService"]').val() || 0;
            let quantity = parseFloat($(element).find('input[id^="txtQty"]').val()) || 0;
            let price = parseFloat($(element).find('input[id^="txtPrice"]').val()) || 0;
            let discountPercent = parseFloat($(element).find('input[id^="txtDiscount"]').val()) || 0;
            let vatPercent = parseFloat($(element).find('input[id^="txtVat"]').val()) || 0;

            let subAmount = quantity * price;
            let discountAmount = (subAmount * discountPercent) / 100;
            let vatAmount = (subAmount * vatPercent) / 100;
            let totalAmount = subAmount - discountAmount + vatAmount;

            let item = {
                Service: service,
                Product: $(element).find('select[id^="txtProduct"]').val(),
                Quantity: quantity,
                Price: price,
                VAT: vatPercent,
                Discount: discountPercent,
                SingleDiscountAmount: discountAmount,
                SubAmount: subAmount,
                TotalAmount: totalAmount
            };

            invoiceData.Items.push(item);
        });

        $.ajax({
            url: '/AddInvoice',
            type: 'POST',
            data: JSON.stringify(invoiceData),
            contentType: 'application/json',
            success: function (res) {
                Info(res.statusCode, res.responseText)
                // window.location.href = '@Url.Action("Index", "Invoices")';
            },
            error: function (error) {
                console.log(error);
                alert('Error Creating Invoice');
            }
        });
    }

    function validateInvoiceFields() {
        let isValid = true;
        if ($('#txtName').val().trim() === '') {
            isValid = false;
        }
        if ($('#txtEmail').val().trim() === '') {
            isValid = false;
        }
        if ($('#txtPhone').val().trim() === '') {
            isValid = false;
        }
        if ($('#txtAddress').val().trim() === '') {
            isValid = false;
        }

        $('.rowClass').each(function (index, element) {
            let isRowValid = true;
            $(element).find('input[id^="txtQty"], input[id^="txtPrice"], input[id^="txtDiscount"], input[id^="txtVat"]').each(function () {
                if ($(this).val().trim() === '') {
                    isRowValid = false;
                    return false;
                }
            });
            if (!isRowValid) {
                isValid = false;
                return false;
            }
        });

        return isValid;
    }


    function GetMedicines() {
        debugger;
        return $.post('/GetMedicine')
            .then(function (med) {
                let options = '<option>Select Product</option>';
                med.forEach(function (item) {
                    options += `<option value="${item.name}">${item.name}</option>`;
                });
                return options;
            })
            .catch(function () {
                alert('Failed to fetch medicines.');
                return '<option>Select Product</option>';
            });
    }

</script>



